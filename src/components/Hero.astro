---
import { heroMessages } from '../data/site';

interface Props {
  lang: 'fa' | 'en';
}

const { lang } = Astro.props;
const isFa = lang === 'fa';
const msgs = heroMessages[lang];
---

<section class="mix-hero" data-hero-root data-lang={lang}>
  <div class="mix-hero__media">
    <video
      class="mix-hero__video"
      data-hero-video
      muted
      playsinline
      preload="auto"
    ></video>
    <img
      class="mix-hero__image"
      data-hero-fallback
      src="/media/hero/images/hero-01.jpg"
      alt="MixPlus hero"
      hidden
    />
  </div>
  <div class="mix-hero__overlay"></div>

  <div class="mix-container mix-hero__content">
    <div>
      <div data-hero-message>
        <h1 class="mix-hero__title"></h1>
        <p class="mix-hero__subtitle"></p>
      </div>
    </div>
  </div>

  <div class="mix-hero__scroll">
    <button
      class="mix-hero__scroll-button"
      type="button"
      aria-label={isFa ? 'اسکرول به پایین' : 'Scroll down'}
      data-hero-scroll
    >
      <svg width="18" height="18" viewBox="0 0 24 24">
        <path
          d="M12 4v16m0 0-5-5m5 5 5-5"
          stroke="currentColor"
          stroke-width="1.6"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>
  </div>

  <script is:inline>
    (function () {
      const root = document.querySelector('[data-hero-root]');
      if (!root) return;
      const lang = root.getAttribute('data-lang') || 'fa';
      const videoEl = root.querySelector('[data-hero-video]');
      const imgFallback = root.querySelector('[data-hero-fallback]');
      const titleEl = root.querySelector('.mix-hero__title');
      const subtitleEl = root.querySelector('.mix-hero__subtitle');
      const scrollBtn = root.querySelector('[data-hero-scroll]');

      const messages = {msgsJson};

      function shuffle(arr) {
        const a = arr.slice();
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      const msgList = shuffle(messages[lang] || messages.fa);
      let msgIndex = 0;

      function showMsg() {
        const m = msgList[msgIndex];
        if (!m) return;
        titleEl.textContent = m.title;
        subtitleEl.textContent = m.subtitle;
        msgIndex = (msgIndex + 1) % msgList.length;
      }

      showMsg();
      setInterval(showMsg, 5000);

      // ویدیوها
      const videoIds = shuffle([1, 2, 3, 4]);
      let vIndex = 0;

      function playNext() {
        if (!videoEl) return;
        const id = videoIds[vIndex];
        const src = `/media/hero/videos/video-0${id}.mp4`;
        videoEl.src = src;
        const playPromise = videoEl.play();
        vIndex = (vIndex + 1) % videoIds.length;
        if (vIndex === 0) {
          // شافل دوباره
          const s = shuffle(videoIds);
          videoIds.length = 0;
          s.forEach((x) => videoIds.push(x));
        }
        if (playPromise && typeof playPromise.then === 'function') {
          playPromise.catch(() => {
            // fallback
            if (imgFallback) {
              const imgId = 1 + Math.floor(Math.random() * 4);
              imgFallback.src = `/media/hero/images/hero-0${imgId}.jpg`;
              imgFallback.hidden = false;
            }
            videoEl.setAttribute('hidden', 'true');
          });
        }
      }

      if (videoEl) {
        videoEl.addEventListener('ended', playNext);
        playNext();
      }

      // اسکرول نرم
      if (scrollBtn) {
        scrollBtn.addEventListener('click', () => {
          const nextSection = root.nextElementSibling;
          if (!nextSection) return;
          nextSection.scrollIntoView({ behavior: 'smooth' });
        });
      }
    })();
  </script>
</section>
